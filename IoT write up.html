<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT write up</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h1 id="make-internet-controlled-led-strips-with-esp8266-arduino-nodejs-and-a-fancy-front-end">Make Internet Controlled LED Strips with ESP8266, Arduino, NodeJS, and a Fancy front end</h1>
<p>This tutorial is going to show you how to make a internet controlled LED strip using ESP8266/Arduino/WS2812B LEDs for hardware and NodeJS/HTML/CSS/JS for the front and back end.</p>
<p>The ESP for the LEDs also uses WiFi Manager and SPIFFS to dynamically connect the device to WiFi (without requiring reprogramming), and to store any API keys or RGB color values in the flash so it is persistent across reboot. Like how if you unplug an IoT device and plug it back it, it still knows how to connect to WiFi and knows it belongs to your account.</p>
<p>While MQTT would serve as a perfect utility here (especially using something like Blynk as an app for controlling the colors, as well as easy control from mobile), I wanted to get something up and running relatively quickly, while also doing everything pretty much myself (yes there is a lot of code snagging). Setting up MQTT is quite annoying and if it’s not something you already understand well then learning it here would not be advised. Using MQTT would require at a minimum adding it to both the device and the back end, front end could be optional.</p>
<p><em>Note to Dr. Cotton: I am writing it about this device instead of the MQTT because I feel this is a more complete end product. If you would rather me write this about the MQTT setup then I would be happy to but I feel this is something thast others might want to see, as well as it touching more areas like front end which the other project did not.</em></p>
<h2 id="programming">Programming</h2>
<p>There is a lot of code here, <strong>a lot</strong>. Between the back end(s), front end, and Arduino code, doing a walkthrough programming tutorial would be absurd. Instead, I am going to highlight the core features of the code that makes it so special (I don’t need to explain how to setup an express server now do I?). I’ll get to more of the code later.</p>
<h2 id="wiring">Wiring</h2>
<p>There are a bunch of ways to handle wiring up the LEDs so I am going to let you do that on your own account. Personally I used an external power supply for both the LEDs and the ESP8266, and made all of the ground connect. I put a 370ohm resistor (you can use anything just put something there) between the data pin of the ESP and the LEDs, and a 1000µf capacitor to protect the electronics from surges. Here is a diagram similar to what I did:</p>
<p><img src="http://blog.knor.net/wp-content/uploads/2016/04/image-1.png" alt="Credit http://blog.knor.net/wp-content/uploads/2016/04/image-1.png"></p>
<h2 id="diagram-of-data">Diagram of Data</h2>
<p>This is how all of the data flows:</p>
<div class="mermaid"><svg xmlns="http://www.w3.org/2000/svg" id="mermaid-svg-mbYmELgdebUnWwwm" height="100%" viewBox="0 0 407.6875 202" style="max-width:407.6875px;"><g><g class="output"><g class="clusters"></g><g class="edgePaths"><g class="edgePath" style="opacity: 1;"><path class="path" d="M212.9375,43L237.9375,43L283.4893444666002,71.4481555333998" marker-end="url(#arrowhead1014)" style="fill:none"></path><defs><marker id="arrowhead1014" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path></marker></defs></g><g class="edgePath" style="opacity: 1;"><path class="path" d="M190.78125,139L237.9375,139L283.4893444666002,111.5518444666002" marker-end="url(#arrowhead1015)" style="fill:none"></path><defs><marker id="arrowhead1015" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path></marker></defs></g></g><g class="edgeLabels"><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g class="node" id="A" transform="translate(116.46875,43)" style="opacity: 1;"><rect rx="0" ry="0" x="-96.46875" y="-23" width="192.9375" height="46"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-86.46875,-13)"><foreignObject width="172.9375" height="26"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Front End -color control-</div></foreignObject></g></g></g><g class="node" id="D" transform="translate(315.3125,91)" style="opacity: 1;"><polygon points="52.375,0 104.75,-52.375 52.375,-104.75 0,-52.375" rx="5" ry="5" transform="translate(-52.375,52.375)"></polygon><g class="label" transform="translate(0,0)"><g transform="translate(-32.46875,-13)"><foreignObject width="64.9375" height="26"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Back End</div></foreignObject></g></g></g><g class="node" id="B" transform="translate(116.46875,139)" style="opacity: 1;"><rect rx="0" ry="0" x="-74.3125" y="-23" width="148.625" height="46"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-64.3125,-13)"><foreignObject width="128.625" height="26"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">ESP8266 w/ LEDs</div></foreignObject></g></g></g></g></g></g></svg></div>
<p>Simple, right?</p>
<h2 id="the-backend">The backend</h2>
<p>Since 2 of our points reach out to the backend, we gotta deal with that first. Included in this repo is a file <code>index.js</code>, that is all you need for the backend.</p>
<p>Looking at the code, there are really two important parts, setting the colors and serving the colors (GET and POST requests):</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">let</span> redC <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> blueC <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> greenC <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">"/getcolors"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token keyword">let</span> colors <span class="token operator">=</span> <span class="token punctuation">{</span>
red<span class="token punctuation">:</span> redC<span class="token punctuation">,</span>
blue<span class="token punctuation">:</span> blueC<span class="token punctuation">,</span>
green<span class="token punctuation">:</span> greenC
<span class="token punctuation">}</span><span class="token punctuation">;</span>
res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>colors<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/setcolors"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
redC <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>redColor<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Set Red to: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>redC<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
blueC <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>blueColor<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Set Blue to: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>blueC<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
greenC <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>greenColor<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Set Green to: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>greenC<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"Got colors"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>I start by setting the colors to full white. This is just so I know what the colors are before changing them (useful for debugging).</p>
<p>Our get request is going to serve the colors as stringified JSON (stringified JSON is required for the ArduinoJSON library, and also becomes less of a headache as long as you remember to unstringify it on the other end).</p>
<p>We also have to be able to let our front end (or with the current lack of authentication and security, anyone) set the colors of the device. for that we setup a POST request to the url extension <code>/setcolors</code> which will expect a JSON object containing the three colors accordingly. The function will then update the variables with those colors, and tell the sender that it got the colors.</p>
<p>The backend is by <strong>FAR</strong> the simplest part. Buckle in…</p>
<h2 id="the-esp-and-leds">The ESP and LEDs</h2>
<p>I’m going to go ahead and say it up front. There is a lot of overkill and commented out code for future use (most of the commented out stuff was from adapting it from the ESP32 to the ESP8266). That’s why I am going to highlight the important parts. Let’s dig in.</p>
<p>The first notable aspect is to make sure we have all of the correct libraries. Additionally (for FastLEDs), we need to make sure that it knows how to deal with out board. I used a WeMos D1 mini here, so choose which define statement you need for your board.</p>
<pre><code>#define FASTLED_ESP8266_RAW_PIN_ORDER
#define FASTLED_ESP8266_NODEMCU_PIN_ORDER
#define FASTLED_ESP8266_D1_PIN_ORDER
</code></pre>
<p>For everyone’s sanity I made the colors start all 0 so the LED strip is off until it loads the colors.</p>
<p>Next we need to program in some kind of persistent storage. For that we need SPIFFS. SPIFFS comes as part of the <code>FS.h</code> library for ESP8266 (you need the <code>SPIFFS.h</code> for ESP32). For our code, we need to make sure we can open a file system, check for our JSON object (and if not, create it), and then read the data into variables in memory:</p>
<pre class=" language-c"><code class="prism  language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>SPIFFS<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"mounted file system"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>SPIFFS<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">"/config.json"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//file exists, reading and loading</span>
Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"reading config file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
File configFile <span class="token operator">=</span> SPIFFS<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/config.json"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>configFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"opened config file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
size_t size <span class="token operator">=</span> configFile<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Allocate a buffer to store contents of the file.</span>
std<span class="token punctuation">:</span><span class="token punctuation">:</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token function">buf</span><span class="token punctuation">(</span>new <span class="token keyword">char</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
configFile<span class="token punctuation">.</span><span class="token function">readBytes</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
DynamicJsonBuffer jsonBuffer<span class="token punctuation">;</span>
JsonObject<span class="token operator">&amp;</span> json <span class="token operator">=</span> jsonBuffer<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
json<span class="token punctuation">.</span><span class="token function">printTo</span><span class="token punctuation">(</span>Serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\nparsed json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">strcpy</span><span class="token punctuation">(</span>apikey<span class="token punctuation">,</span> json<span class="token punctuation">[</span><span class="token string">"apikey"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">strcpy</span><span class="token punctuation">(</span>redC<span class="token punctuation">,</span> json<span class="token punctuation">[</span><span class="token string">"redC"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">strcpy</span><span class="token punctuation">(</span>greenC<span class="token punctuation">,</span> json<span class="token punctuation">[</span><span class="token string">"greenC"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">strcpy</span><span class="token punctuation">(</span>blueC<span class="token punctuation">,</span> json<span class="token punctuation">[</span><span class="token string">"blueC"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"failed to load json config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"failed to mount FS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><em>Thank you github copy and paste/stackedit for preserving indentation :/ …</em></p>
<p>Next we have to setup WiFiManager so we can connect to WiFi without having to hardcode credentials. One thing I found when using ESP32 was that it wouldn 't connect the first time and needed a reboot. However forcing the reboot would cause it to forget the other variables passed in at WiFi allocation time like API keys, so we have to set <code>wifiManager.setBreakAfterConfig(true);</code> in order to let it continue if it fails, then after we store the variables to SPIFFS reboot of the ip is <code>0.0.0.0</code>:</p>
<pre class=" language-c"><code class="prism  language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>WiFi<span class="token punctuation">.</span><span class="token function">localIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"0.0.0.0"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ESP<span class="token punctuation">.</span><span class="token function">restart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>In case you decide security is a good idea, or want to connect to another service, I added a API Key field to the WiFi Manager using the line <code>wifiManager.addParameter(&amp;custom_apikey);</code>, and making sure it is saved in the persistent JSON as well.</p>
<p>Once we get into our loop, we need to first load the LED colors from storage. Then we have to make the GET request out to the backend to check if we need new colors. The most important thing here is to make sure we grab the returned data, parse it as JSON, and update the SPIFFS variables before showing it (better to store the data first just in case):</p>
<pre class=" language-c"><code class="prism  language-c">String payload <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

StaticJsonBuffer<span class="token operator">&lt;</span><span class="token number">200</span><span class="token operator">&gt;</span> jsonBuffers<span class="token punctuation">;</span>
JsonObject<span class="token operator">&amp;</span> colorData <span class="token operator">=</span> jsonBuffers<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"HERE IS THE JSON DATATA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
colorData<span class="token punctuation">.</span><span class="token function">printTo</span><span class="token punctuation">(</span>Serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">strcpy</span><span class="token punctuation">(</span>redC<span class="token punctuation">,</span> colorData<span class="token punctuation">[</span><span class="token string">"red"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">strcpy</span><span class="token punctuation">(</span>greenC<span class="token punctuation">,</span> colorData<span class="token punctuation">[</span><span class="token string">"green"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">strcpy</span><span class="token punctuation">(</span>blueC<span class="token punctuation">,</span> colorData<span class="token punctuation">[</span><span class="token string">"blue"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"PARSED THE NEW JSON"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// update the stored json</span>
DynamicJsonBuffer jsonBuffer<span class="token punctuation">;</span>
JsonObject<span class="token operator">&amp;</span> json <span class="token operator">=</span> jsonBuffer<span class="token punctuation">.</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
json<span class="token punctuation">[</span><span class="token string">"apikey"</span><span class="token punctuation">]</span> <span class="token operator">=</span> apikey<span class="token punctuation">;</span>
json<span class="token punctuation">[</span><span class="token string">"redC"</span><span class="token punctuation">]</span> <span class="token operator">=</span> redC<span class="token punctuation">;</span>
json<span class="token punctuation">[</span><span class="token string">"greenC"</span><span class="token punctuation">]</span> <span class="token operator">=</span> greenC<span class="token punctuation">;</span>
json<span class="token punctuation">[</span><span class="token string">"blueC"</span><span class="token punctuation">]</span> <span class="token operator">=</span> blueC<span class="token punctuation">;</span>
File configFile <span class="token operator">=</span> SPIFFS<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/config.json"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>configFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"failed to open config file for writing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Then on the next loop, our updated variables get displayed on the LED strip.</p>
<p>Being able to grab this code rather than writing it from the ground up is like eating dry rice with a spoon vs. chop-sticks: <strong>It’s just easier this way.</strong></p>
<h2 id="front-end">Front end</h2>
<p>There are 2 reasons the front end is in a tarball right now:</p>
<ol>
<li>I wrote it in <a href="http://c9.io">c9.io</a> and exported it</li>
<li>It doesn’t have a whole lot of explaning to do</li>
</ol>
<p>Basically, I grabbed a pure HTML/CSS/JS color picker from a codepen I found, stuffed it behind another NodeJS Express server (I could have used something easier like a firebase front end but I was in the mood to get better at serving front ends with Express), and made it reach out to the backend on a <code>mouseup</code> event. There are 3 ways I could have handled sending a new color:</p>
<ol>
<li>On any mouse up event (Which I did)</li>
<li>On a new color choice (Bad idea, will explain next)</li>
<li>On a mouse up when a new color is selected (to make sure I can’t just click anywhere and send a new request which doesn’t really matter)</li>
</ol>
<p>The reason sending a request out on a new color choice is because every pixel the mouse drags a selector <strong>is a new color choice</strong>. Running across the box results in like 50 something colors choices… <strong>nobody wants to get DoS’d from a color picker</strong>. The third option was just more work than worth since it is just a proof of concept. I added in a JS alert on color change for debugging purposes. One important thing to note is that you probably want to load the front end over HTTP rather than HTTPS if you don’t put a cert on what ever server is running the backend (I used a digital ocean droplet and didn’t bother with a cert, steal my RGB values I dare you). That way you can avoid CORS and Mixed-Media errors. Speaking of CORS I’m pretty sure some of the things in the backend <code>index.js</code> file regarding CORS aren’t necessary but I was trying everything when debugging Mixed-Media and pre-flight checks.</p>
<h2 id="wrapping-up">Wrapping Up</h2>
<p>Now it’s time to flash your ESP, make sure you are pointed at the IPs that aren’t mine (unless we all want to have the same color LEDs based on who ever wants to set the color), and fire away. Once you connect your ESP to your WiFi network, it should begin grabbing the current colors from the backend. The colors will be restored on power cycle, and will fetch new colors once it can connect to WiFi. If it can’t connect to WiFi for long enough on the first connect, it should reload WiFiManager. You could add a button to reset the storage and WiFiManager settings as a sort of factory restore option.</p>
<p><a href="https://photos.app.goo.gl/S7zCvHj7qrg3Tiu42">Here</a> is a video I made demoing the device once I got the front end color selector working.</p>
<p>Enjoy :)</p>
</div>
</body>

</html>
